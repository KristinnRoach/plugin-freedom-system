# Parameter Specification: SimpleSampler

**CRITICAL CONTRACT:** This specification is immutable during implementation.

**Generated by:** UI mockup finalization (ui-mockup skill, v2)
**Generated date:** 2025-12-18
**Source:** v2-ui.yaml (finalized mockup)
**Validated against:** parameter-spec-draft.md (consistent)

---

## Total Parameter Count

**Total:** 2 parameters

---

## Parameter Definitions

### volume

- **Type:** Float
- **Range:** 0.0 to 1.0 (normalized)
- **Default:** 0.75
- **Skew Factor:** Linear
- **Unit:** None (normalized gain)
- **Decimals:** 2 (displays as "0.75")
- **UI Control:** Rotary knob, 120px diameter, left position in controls area
- **UI Behavior:**
  - Drag vertically to adjust (relative delta, not absolute)
  - Mouse wheel for fine control
  - Double-click to reset to 0.75
  - Rotation range: -135° (min) to +135° (max)
- **DSP Usage:** Controls output volume/gain for the sampled audio. Works in conjunction with MIDI velocity to determine final playback volume. Applied as linear gain multiplier to audio buffer.

---

### tuning

- **Type:** Float
- **Range:** -12.0 to +12.0 semitones
- **Default:** 0.0
- **Skew Factor:** Linear
- **Unit:** "st" (semitones)
- **Decimals:** 1 (displays as "0.0 st" or "±12.0 st")
- **UI Control:** Rotary knob, 120px diameter, right position in controls area
- **UI Behavior:**
  - Drag vertically to adjust (relative delta, not absolute)
  - Mouse wheel for fine control
  - Double-click to reset to 0.0 st
  - Rotation range: -135° (min) to +135° (max)
- **DSP Usage:** Adjusts pitch offset from the root note (C3/MIDI 60). Allows transposition of the loaded sample up to ±1 octave. Applied to pitch-shifting algorithm for all voices. Combines with MIDI note number to determine final playback rate.

---

## UI Layout (v2 Mockup)

**Window Size:** 500x350 pixels (non-resizable)

**Section 1: Sample Area (top, y=20, height=120)**
- Dropzone for drag-and-drop audio files (WAV, AIFF, MP3)
- Browse button inside dropzone (folder icon, top-left corner)
- Sample name display when file loaded

**Section 2: Controls Area (bottom, y=160, height=170)**
- Volume knob (left, x=100)
- Tuning knob (right, x=280)
- 60px gap between knobs

---

## WebView Integration

**Relay Types:**
- volume → `juce::WebSliderRelay`
- tuning → `juce::WebSliderRelay`

**Attachment Types:**
- volume → `juce::WebSliderParameterAttachment`
- tuning → `juce::WebSliderParameterAttachment`

**JavaScript Binding:**
```javascript
// Import JUCE module
import { getSliderState } from './js/juce/index.js';

// Get parameter states
const volumeState = getSliderState('volume');
const tuningState = getSliderState('tuning');

// Knob interaction (relative drag)
knob.addEventListener('mousedown', (e) => {
    isDragging = true;
    lastY = e.clientY;  // Frame-to-frame delta, not absolute
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const deltaY = lastY - e.clientY;  // Relative movement
    const newValue = currentValue + (deltaY * sensitivity);
    paramState.setNormalisedValue(normalize(newValue));
    lastY = e.clientY;  // Update for next frame
});

// Double-click reset
knob.addEventListener('dblclick', () => {
    const defaultNormalized = (defaultValue - min) / (max - min);
    paramState.setNormalisedValue(defaultNormalized);
});

// Listen for C++ updates (automation, preset recall)
volumeState.valueChangedEvent.addListener(() => {
    const value = volumeState.getNormalisedValue();
    updateKnobVisual(value);
});
```

---

## Implementation Notes

### DSP Implementation (Stage 4)

1. **Root Note:** C3 (MIDI 60) triggers sample at original pitch
2. **Polyphony:** 16 voices with voice stealing (oldest voice first)
3. **Velocity Sensitivity:** MIDI velocity controls playback volume (multiplied with volume parameter)
4. **Pitch Calculation:**
   ```
   semitoneOffset = (midiNote - 60) + tuningParameter
   playbackRate = pow(2.0, semitoneOffset / 12.0)
   ```
5. **Sample Loading:** Drag-drop + file browser (WAV, AIFF, MP3 support)
6. **Audio Buffer:** Single sample loaded into `juce::AudioBuffer<float>`
7. **Resampling:** Linear interpolation for pitch shifting

### Parameter Order (APVTS)

Parameters MUST be added to AudioProcessorValueTreeState in this exact order:

1. volume
2. tuning

**Rationale:** UI mockup defines parameters in this visual order (left to right). Maintaining consistent order across APVTS, PluginEditor, and UI simplifies debugging.

### WebView Member Order (CRITICAL)

C++ class members MUST be declared in this order to prevent release build crashes:

```cpp
// 1. RELAYS FIRST
std::unique_ptr<juce::WebSliderRelay> volumeRelay;
std::unique_ptr<juce::WebSliderRelay> tuningRelay;

// 2. WEBVIEW SECOND
std::unique_ptr<juce::WebBrowserComponent> webView;

// 3. ATTACHMENTS LAST
std::unique_ptr<juce::WebSliderParameterAttachment> volumeAttachment;
std::unique_ptr<juce::WebSliderParameterAttachment> tuningAttachment;
```

**Why:** Members destroyed in reverse order. Attachments call `evaluateJavascript()` during destruction, so they must be destroyed BEFORE WebView.

### Double-Click Reset Behavior

Both knobs support double-click reset to default value:
- Volume: Double-click → 0.75 (75% gain)
- Tuning: Double-click → 0.0 st (original pitch)

**Implementation:** JavaScript detects double-click, calculates normalized default value, calls `setNormalisedValue()`.

---

## Validation Summary

**Consistency check (draft vs mockup):**
- ✅ Parameter count matches: 2 parameters (volume, tuning)
- ✅ Parameter IDs match exactly
- ✅ Parameter types match: Both Float
- ✅ Ranges match: volume [0.0, 1.0], tuning [-12.0, 12.0]
- ✅ Defaults match: volume 0.75, tuning 0.0
- ✅ DSP purposes match (gain control, pitch shifting)

**No conflicts detected.** Full specification generated from v2 mockup.

---

## Next Steps

- [ ] Stage 2 (Shell): Implement APVTS with these 2 parameters (exact IDs, ranges, defaults)
- [ ] Stage 3 (GUI): Integrate v2-ui.html WebView with parameter bindings
- [ ] Stage 4 (DSP): Implement sampler engine (voice management, pitch shifting, sample loading)
- [ ] Stage 5 (Testing): Verify parameter persistence, automation, preset recall

---

## References

- **UI Mockup:** `plugins/SimpleSampler/.ideas/mockups/v2-ui.yaml`
- **Test HTML:** `plugins/SimpleSampler/.ideas/mockups/v2-ui-test.html`
- **Draft Spec:** `plugins/SimpleSampler/.ideas/parameter-spec-draft.md`
- **Integration Guide:** `plugins/SimpleSampler/.ideas/mockups/v2-integration-checklist.md`
- **JUCE Patterns:** `troubleshooting/patterns/juce8-critical-patterns.md`
